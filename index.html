<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Season Tracker</title>
    <style>
        /* Global Reset & Layout */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #121212; color: #e0e0e0; overflow-x: hidden; }
        
        .app-layout { display: flex; min-height: 100vh; }

        /* --- SIDEBAR STYLES --- */
        .sidebar {
            width: 250px;
            background: #181818;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: fixed;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        .sidebar-title { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 30px; padding-left: 10px; }
        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 10px;
            color: #888;
            text-decoration: none;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
            cursor: pointer;
        }
        .nav-item:hover { background: #2c2c2e; color: #fff; }
        .nav-item.active { background: #2c2c2e; color: #0a84ff; font-weight: bold; }
        
        /* --- MAIN CONTENT STYLES --- */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .view-container {
            width: 100%; max-width: 600px; text-align: center; margin-bottom: 80px;
            display: none; 
        }
        .view-container.active-view { display: block; }

        .card-box { background: #1e1e1e; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }

        .menu-toggle {
            display: none;
            position: fixed; top: 15px; left: 15px; z-index: 101;
            background: #2c2c2e; border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;
        }

        /* --- UI ELEMENTS --- */
        h1 { margin: 0; font-size: 1.5rem; color: #fff; margin-bottom: 5px; }
        p.subtitle { color: #888; margin-bottom: 25px; font-size: 0.9em; }
        
        #display { font-size: 3.5em; margin: 10px 0 20px 0; font-weight: 800; font-variant-numeric: tabular-nums; color: #fff; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-label { font-size: 0.75em; color: #888; margin-bottom: 5px; display: block; margin-left: 5px; text-transform: uppercase; font-weight: bold;}
        
        #noteInput, #fsTypeSelect, #sleepDate, #sleepHours { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #333; background: #2c2c2e; color: white; font-size: 1rem; box-sizing: border-box; outline: none; appearance: none; }
        #noteInput:focus, #fsTypeSelect:focus, #sleepDate:focus, #sleepHours:focus { border-color: #0a84ff; }
        #fsTypeSelect { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23888888%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; }
        
        .status-badge { display: inline-block; padding: 6px 15px; border-radius: 50px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; background: #333; color: #888;}
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { padding: 15px; border: none; border-radius: 16px; cursor: pointer; font-weight: 700; transition: transform 0.1s; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.9rem; color: white; width: 100%;}
        button:active { transform: scale(0.96); }
        .btn-fs { background: linear-gradient(135deg, #ff3b30, #cc2d24); } 
        .btn-uni { background: linear-gradient(135deg, #0a84ff, #0060c0); } 
        .btn-free { background: linear-gradient(135deg, #30d158, #249e42); }
        .btn-sleep-action { background: linear-gradient(135deg, #bf5af2, #5e5ce6); margin-top: 10px;}
        .btn-stop { background: #2c2c2e; border: 1px solid #ff453a; color: #ff453a; display: none; padding: 20px; font-size: 1rem;}
        
        .stat-filter { display: flex; justify-content: center; gap: 5px; margin-top: 30px; margin-bottom: 10px; flex-wrap: wrap;}
        .stat-tab { background: #2c2c2e; border: 1px solid #444; color: #888; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; cursor: pointer; margin-bottom: 5px;}
        .stat-tab.active { background: #444; color: white; border-color: #666; font-weight: bold; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .dash-card { background: #2c2c2e; padding: 12px 8px; border-radius: 12px; text-align: left; transition: 0.3s; }
        .dash-label { font-size: 0.65em; text-transform: uppercase; color: #888; font-weight: bold; display: block; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .dash-val { font-size: 1.1em; font-weight: 800; color: white; display: block;}
        .dash-sub { font-size: 0.7em; color: #666; font-weight: normal; margin-top: 2px; display: block;}

        .chart-container { margin-top: 20px; padding: 20px; background: #2c2c2e; border-radius: 12px; }
        .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; padding-bottom: 20px; }
        .bar-col { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; width: 12%; }
        .stacked-bar { width: 100%; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column-reverse; background: #3a3a3c; min-height: 2px; transition: height 0.5s;}
        .segment { width: 100%; }
        .bar-day { font-size: 0.6em; color: #888; margin-top: 5px; }

        .sleep-section { background: #252525; padding: 15px; border-radius: 15px; margin-top: 20px; border: 1px solid #333; }
        .sleep-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .btn-export { background: transparent; border: 1px solid #444; color: #888; padding: 10px; font-size: 0.8em; margin-top: 30px; width: auto; display: inline-block; border-radius: 8px;}
        .log-list { list-style: none; padding: 0; text-align: left; margin-top: 25px; font-size: 0.9em; }
        .log-list li { padding: 12px 0; border-bottom: 1px solid #333; display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 10px;}
        .btn-delete { background: none; border: none; color: #444; font-size: 1.2em; padding: 5px;}
        .log-note { display: block; color: #aaa; font-style: italic; font-size: 0.85em; }
        .sub-tag { display: inline-block; font-size: 0.75em; background: #3a3a3c; padding: 2px 6px; border-radius: 4px; color: #ddd; margin-left: 5px; vertical-align: middle;}

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.open { transform: translateX(0); box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
            .main-content { margin-left: 0; padding-top: 60px; }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>

<button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

<div class="app-layout">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-title">‚ö° Tracker App</div>
        
        <div class="nav-item active" id="nav-dashboard" onclick="showView('dashboard')">
            <span>üè†</span> Dashboard
        </div>
        <div class="nav-item" id="nav-tracker" onclick="showView('tracker')">
            <span>‚è±Ô∏è</span> Tracker
        </div>
        <div class="nav-item" onclick="alert('Bald verf√ºgbar!')">
            <span>üìÖ</span> Kalender
        </div>
    </div>

    <div class="main-content">
        
        <div id="view-dashboard" class="view-container active-view">
            <div class="card-box">
                <h1>Willkommen</h1>
                <p class="subtitle">Saison 25/26 ‚Ä¢ Version 7.4</p>

                <p class="input-label" style="text-align:center; margin-bottom:10px;">Schnellstart</p>
                <div class="btn-grid start-buttons-container">
                    <button class="btn-fs" onclick="startWork('FS')">üèéÔ∏è FS Team</button>
                    <button class="btn-uni" onclick="startWork('Uni')">üéì Uni</button>
                    <button class="btn-free" onclick="startWork('Freizeit')">üèñÔ∏è Freizeit</button>
                </div>

                <div class="chart-container">
                    <span class="dash-label" style="margin-bottom:15px">Wochen-Trend (Alles)</span>
                    <div class="bar-chart" id="weekChartDash"></div>
                </div>
                
                <div style="margin-top:20px; font-size:0.8em; color:#666">
                    Total (Lifetime): <span id="totalHours" style="color:white; font-weight:bold">0</span>h
                </div>
            </div>
        </div>

        <div id="view-tracker" class="view-container">
            <div class="card-box">
                <h1>Cockpit</h1>
                <div id="statusBadge" class="status-badge">Lade...</div>
                <div id="display">--:--:--</div>
                
                <div id="inputArea">
                    <div class="input-group">
                        <span class="input-label">1. FS Kategorie (optional)</span>
                        <select id="fsTypeSelect">
                            <option value="Arbeit">üõ†Ô∏è Arbeit (Allgemein)</option>
                            <option value="Werkstatt">üîß Werkstatt</option>
                            <option value="Sitzung">üó£Ô∏è Sitzung</option>
                            <option value="Au√üentermin">üåç Au√üentermin</option>
                            <option value="Im Auto unterwegs">üöó Im Auto unterwegs</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <span class="input-label">2. Notiz</span>
                        <input type="text" id="noteInput" placeholder="Was machst du?">
                    </div>

                    <div class="btn-grid start-buttons-container">
                        <button class="btn-fs" onclick="startWork('FS')">üèéÔ∏è FS Team</button>
                        <button class="btn-uni" onclick="startWork('Uni')">üéì Uni</button>
                        <button class="btn-free" onclick="startWork('Freizeit')">üèñÔ∏è Freizeit</button>
                    </div>
                </div>

                <button id="stopBtn" class="btn-stop" onclick="stopWork()">‚èπ Session beenden</button>

                <div class="sleep-section">
                    <span class="input-label" style="margin-bottom:10px">üò¥ Schlaf nachtragen</span>
                    <div class="sleep-grid">
                        <input type="date" id="sleepDate">
                        <input type="number" id="sleepHours" placeholder="Stunden" step="0.5">
                    </div>
                    <button class="btn-sleep-action" onclick="addSleep()">üíæ Speichern</button>
                </div>

                <div class="stat-filter">
                    <div class="stat-tab active" id="tabFS" onclick="switchStatView('FS')">üèéÔ∏è FS</div>
                    <div class="stat-tab" id="tabUni" onclick="switchStatView('Uni')">üéì Uni</div>
                    <div class="stat-tab" id="tabFree" onclick="switchStatView('Freizeit')">üèñÔ∏è Frei</div>
                    <div class="stat-tab" id="tabSleep" onclick="switchStatView('Schlaf')">üò¥ Schlaf</div>
                </div>

                <div class="dashboard-grid">
                    <div class="dash-card">
                        <span class="dash-label">üóìÔ∏è Saison <span id="lblSeason">25/26</span></span>
                        <span class="dash-val" id="valSeason">0h</span>
                        <span class="dash-sub">Seit Sept.</span>
                    </div>
                    <div class="dash-card">
                        <span class="dash-label">üìÖ Jahr <span id="lblYear">2026</span></span>
                        <span class="dash-val" id="valYear">0h</span>
                        <span class="dash-sub">Jan - Dez</span>
                    </div>
                    <div class="dash-card">
                        <span class="dash-label">üìà √ò / Monat</span>
                        <span class="dash-val" id="valAvg">0h</span>
                        <span class="dash-sub">in Saison</span>
                    </div>
                </div>

                <div class="chart-container">
                    <span class="dash-label" style="margin-bottom:15px">Wochen-Trend (Alles)</span>
                    <div class="bar-chart" id="weekChartTrack"></div>
                </div>

                <button class="btn-export" onclick="downloadCSV()">üì• Excel Export</button>
                <ul id="logList" class="log-list"></ul>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get, child, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è FIREBASE CONFIG ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
    const firebaseConfig = {
      apiKey: "AIzaSyAKlDrqhXgMASuYkHVQj4TveUt6kjF_pFM",
      authDomain: "zeit-97904.firebaseapp.com",
      databaseURL: "https://zeit-97904-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "zeit-97904",
      storageBucket: "zeit-97904.firebasestorage.app",
      messagingSenderId: "677314069900",
      appId: "1:677314069900:web:6b4baa4d98397dd8cfc2a9"
    };
    // ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è ENDE ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let tInterval;
    let localStartTime = 0;
    let historyData = {};
    let calculatedStats = {}; 
    let currentStatView = "FS"; 
    const colors = { 'FS': '#ff3b30', 'Uni': '#0a84ff', 'Freizeit': '#30d158', 'Schlaf': '#bf5af2' };
    const labels = { 'FS': 'FS Team', 'Uni': 'Uni', 'Freizeit': 'Freizeit', 'Schlaf': 'Schlaf' };

    document.getElementById('sleepDate').valueAsDate = new Date();

    window.showView = function(viewName) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active-view'));
        document.getElementById('view-' + viewName).classList.add('active-view');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-' + viewName).classList.add('active');
        document.getElementById('sidebar').classList.remove('open');
    }

    window.toggleMenu = function() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        const btn = document.querySelector('.menu-toggle');
        if(window.innerWidth <= 768 && !sidebar.contains(e.target) && !btn.contains(e.target) && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        }
    });

    function getSeasonTag(timestamp) {
        const d = new Date(timestamp);
        const month = d.getMonth(); 
        const year = d.getFullYear();
        if (month >= 8) {
            return `${year.toString().substr(2)}/${(year+1).toString().substr(2)}`; 
        } else {
            return `${(year-1).toString().substr(2)}/${year.toString().substr(2)}`; 
        }
    }

    onValue(ref(db, 'status'), (snapshot) => {
        const data = snapshot.val();
        if (data && data.running) {
            localStartTime = data.startTime;
            updateUI(true, data.category, data.subCategory);
            if(data.note) document.getElementById('noteInput').value = data.note;
            if(data.subCategory) document.getElementById('fsTypeSelect').value = data.subCategory;
            if (!tInterval) tInterval = setInterval(updateDisplay, 1000);
        } else {
            if (tInterval) { clearInterval(tInterval); tInterval = null; }
            updateUI(false, "");
            document.getElementById('display').innerHTML = "Bereit";
            document.getElementById('statusBadge').innerText = "W√§hle Modus";
            document.getElementById('statusBadge').style.color = "#888";
            document.getElementById('noteInput').value = "";
        }
    });

    onValue(ref(db, 'history'), (snapshot) => { 
        historyData = snapshot.val() || {};
        processData(historyData); 
    });

    window.startWork = function(category) {
        showView('tracker');
        const now = new Date().getTime();
        const note = document.getElementById('noteInput').value;
        let subCat = "";
        if (category === 'FS') subCat = document.getElementById('fsTypeSelect').value;

        get(child(ref(db), 'status/lastStop')).then((snapshot) => {
            set(ref(db, 'status'), { running: true, startTime: now, category: category, subCategory: subCat, lastStop: 0, note: note });
        });
    }

    window.stopWork = function() {
        get(child(ref(db), 'status')).then((snapshot) => {
            const state = snapshot.val();
            if (state && state.running) {
                const now = new Date().getTime();
                const finalNote = document.getElementById('noteInput').value;
                push(ref(db, 'history'), { 
                    category: state.category, subCategory: state.subCategory || "", 
                    start: state.startTime, end: now, duration: now - state.startTime, 
                    date: new Date(state.startTime).toLocaleDateString(), note: finalNote 
                });
                set(ref(db, 'status'), { running: false, startTime: 0, category: "", lastStop: now, note: "" });
            }
        });
    }

    window.addSleep = function() {
        const h = parseFloat(document.getElementById('sleepHours').value);
        if(!h || h <= 0) return alert("Bitte Stunden eingeben");

        const dateInput = document.getElementById('sleepDate').valueAsDate;
        if(!dateInput) return alert("Bitte Datum w√§hlen");
        
        const dateStr = dateInput.toLocaleDateString(); 
        const durationMs = h * 60 * 60 * 1000;
        const entryTimestamp = dateInput.setHours(8,0,0,0);

        push(ref(db, 'history'), {
            category: 'Schlaf', subCategory: 'Nachtrag', start: entryTimestamp - durationMs, end: entryTimestamp,
            duration: durationMs, date: dateStr, note: "Manuell nachgetragen"
        });

        let timeToDeduct = durationMs;
        let entriesUpdated = 0;
        Object.entries(historyData).forEach(([key, val]) => {
            if(timeToDeduct <= 0) return;
            if(val.category === 'Freizeit' && val.date === dateStr) {
                if(val.duration > timeToDeduct) {
                    update(ref(db, 'history/' + key), { duration: val.duration - timeToDeduct });
                    timeToDeduct = 0; entriesUpdated++;
                } else {
                    timeToDeduct -= val.duration; remove(ref(db, 'history/' + key)); entriesUpdated++;
                }
            }
        });
        alert(`Schlaf gespeichert. ${entriesUpdated} Freizeit-Eintr√§ge verrechnet.`);
        document.getElementById('sleepHours').value = "";
    }

    window.switchStatView = function(view) {
        currentStatView = view;
        document.querySelectorAll('.stat-tab').forEach(el => el.classList.remove('active'));
        if(view === 'FS') document.getElementById('tabFS').classList.add('active');
        if(view === 'Uni') document.getElementById('tabUni').classList.add('active');
        if(view === 'Freizeit') document.getElementById('tabFree').classList.add('active');
        if(view === 'Schlaf') document.getElementById('tabSleep').classList.add('active');
        renderDashboardValues();
    }

    window.deleteItem = function(key) {
        if(confirm("Eintrag l√∂schen?")) remove(ref(db, 'history/' + key));
    }

    window.downloadCSV = function() {
        let csv = "Datum,Saison,Start,Ende,Kategorie,Unterkategorie,Minuten,Notiz\n";
        Object.values(historyData).sort((a,b)=>b.start-a.start).forEach(e => {
            const season = getSeasonTag(e.start);
            const sub = e.subCategory ? e.subCategory : "-";
            const noteClean = (e.note||"").replace(/,/g," ");
            csv += `${new Date(e.start).toLocaleDateString()},${season},${new Date(e.start).toLocaleTimeString()},${new Date(e.end).toLocaleTimeString()},${e.category},${sub},${Math.round(e.duration/60000)},${noteClean}\n`;
        });
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        link.download = "Tracker_Export.csv";
        link.click();
    }

    function updateDisplay() {
        if(!localStartTime) return;
        let diff = new Date().getTime() - localStartTime;
        let hrs = Math.floor(diff / 3600000);
        let mins = Math.floor((diff % 3600000) / 60000);
        let secs = Math.floor((diff % 60000) / 1000);
        document.getElementById('display').innerHTML = (hrs<10?"0"+hrs:hrs) + ':' + (mins<10?"0"+mins:mins) + ':' + (secs<10?"0"+secs:secs);
    }

    function updateUI(running, category, subCategory) {
        const startBtnContainers = document.querySelectorAll('.start-buttons-container');
        const stopBtn = document.getElementById('stopBtn');
        
        if(running) {
            startBtnContainers.forEach(el => el.style.display = 'none');
            stopBtn.style.display = 'block';
            stopBtn.style.borderColor = colors[category] || '#666';
            let badgeText = labels[category] || category;
            if(category === 'FS' && subCategory) badgeText += " ‚Ä¢ " + subCategory;
            document.getElementById('statusBadge').innerText = badgeText;
            document.getElementById('statusBadge').style.color = colors[category] || '#fff';
        } else {
            startBtnContainers.forEach(el => el.style.display = 'grid');
            stopBtn.style.display = 'none';
        }
    }

    function processData(data) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentSeasonTag = getSeasonTag(now.getTime()); 
        
        const seasonStartYear = parseInt("20" + currentSeasonTag.split('/')[0]); 
        let monthsPassed = (now.getFullYear() - seasonStartYear) * 12 + (now.getMonth() - 8);
        if (monthsPassed < 1) monthsPassed = 1; else monthsPassed += 1; 

        calculatedStats = { 'FS': {season:0,year:0}, 'Uni': {season:0,year:0}, 'Freizeit': {season:0,year:0}, 'Schlaf': {season:0,year:0} };
        let sumLifetime = 0;
        let dailySums = {}; 

        document.getElementById('lblSeason').innerText = currentSeasonTag;
        document.getElementById('lblYear').innerText = currentYear;

        const entries = Object.entries(data).sort(([,a],[,b]) => b.start - a.start);
        
        entries.forEach(([key, entry]) => {
            const dur = entry.duration;
            const cat = entry.category || 'FS'; 
            sumLifetime += dur;
            if(calculatedStats[cat]) {
                if (getSeasonTag(entry.start) === currentSeasonTag) calculatedStats[cat].season += dur;
                if (new Date(entry.start).getFullYear() === currentYear) calculatedStats[cat].year += dur;
            }
            const dateKey = new Date(entry.start).toLocaleDateString();
            if(!dailySums[dateKey]) dailySums[dateKey] = { 'FS':0, 'Uni':0, 'Freizeit':0, 'Schlaf':0 };
            if(dailySums[dateKey][cat] !== undefined) dailySums[dateKey][cat] += dur;
        });

        renderDashboardValues(monthsPassed);
        document.getElementById('totalHours').innerText = (sumLifetime / 3600000).toFixed(1);
        renderChart(dailySums);
        renderList(entries);
    }

    function renderDashboardValues(monthsPassedGlobal) {
        if(!monthsPassedGlobal) {
            const now = new Date();
            const seasonStartYear = parseInt("20" + document.getElementById('lblSeason').innerText.split('/')[0]);
            monthsPassedGlobal = (now.getFullYear() - seasonStartYear) * 12 + (now.getMonth() - 8);
            if (monthsPassedGlobal < 1) monthsPassedGlobal = 1; else monthsPassedGlobal += 1;
        }
        const stats = calculatedStats[currentStatView];
        const fmt = (ms) => Math.floor(ms/3600000) + "h " + Math.floor((ms%3600000)/60000) + "m";
        const fmtYr = (ms) => Math.floor(ms/3600000) + "h";

        if(stats) {
            document.getElementById('valSeason').innerText = fmt(stats.season);
            document.getElementById('valYear').innerText = fmtYr(stats.year);
            let avg = stats.season / monthsPassedGlobal;
            document.getElementById('valAvg').innerText = (avg / 3600000).toFixed(1) + "h";
        }
    }

    function renderChart(dailySums) {
        // IDs von BEIDEN Charts (Dashboard & Tracker)
        const targetIDs = ['weekChartDash', 'weekChartTrack'];
        const days = ['So','Mo','Di','Mi','Do','Fr','Sa'];

        targetIDs.forEach(id => {
            const chartDiv = document.getElementById(id);
            if(!chartDiv) return; // Falls ID nicht gefunden (Sicherheit)

            chartDiv.innerHTML = "";
            for (let i = 6; i >= 0; i--) {
                let d = new Date(); d.setDate(d.getDate() - i);
                let dStr = d.toLocaleDateString();
                let dayData = dailySums[dStr] || { 'FS':0, 'Uni':0, 'Freizeit':0, 'Schlaf': 0 };
                let totalMs = dayData.FS + dayData.Uni + dayData.Freizeit + (dayData.Schlaf || 0);
                const MAX_SCALE = 16 * 3600000; 
                let totalHeightPercent = Math.min((totalMs / MAX_SCALE) * 100, 100);
                let pFS = totalMs > 0 ? (dayData.FS / totalMs) * 100 : 0;
                let pUni = totalMs > 0 ? (dayData.Uni / totalMs) * 100 : 0;
                let pFree = totalMs > 0 ? (dayData.Freizeit / totalMs) * 100 : 0;
                let pSleep = totalMs > 0 ? (dayData.Schlaf / totalMs) * 100 : 0;

                chartDiv.innerHTML += `
                <div class="bar-col">
                    <div class="stacked-bar" style="height:${totalHeightPercent}%;">
                        <div class="segment" style="height:${pFS}%; background:${colors.FS}"></div>
                        <div class="segment" style="height:${pUni}%; background:${colors.Uni}"></div>
                        <div class="segment" style="height:${pFree}%; background:${colors.Freizeit}"></div>
                        <div class="segment" style="height:${pSleep}%; background:${colors.Schlaf}"></div>
                    </div>
                    <span class="bar-day">${days[d.getDay()]}</span>
                </div>`;
            }
        });
    }

    function renderList(entries) {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        entries.slice(0, 20).forEach(([key, entry]) => {
            let li = document.createElement('li');
            let hrs = Math.floor(entry.duration / 3600000);
            let mins = Math.floor((entry.duration % 3600000) / 60000);
            let subHtml = (entry.category === 'FS' && entry.subCategory) ? `<span class="sub-tag">${entry.subCategory}</span>` : "";
            let catColor = colors[entry.category] || "#888";
            li.innerHTML = `<div><span style="color:${catColor}; font-weight:bold;">‚óè ${labels[entry.category] || entry.category}</span>${subHtml}<div class="log-meta" style="color:#666; font-size:0.8em; margin-top:2px;">${new Date(entry.start).toLocaleDateString()} ${new Date(entry.start).toLocaleTimeString().substr(0,5)}</div><span class="log-note">${entry.note || ""}</span></div><strong>${hrs}h ${mins}m</strong><button class="btn-delete" onclick="deleteItem('${key}')">√ó</button>`;
            list.appendChild(li);
        });
    }
</script>
</body>
</html>
