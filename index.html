<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life OS</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --accent-fs: #ff3b30;
            --accent-uni: #0a84ff;
            --accent-free: #30d158;
            --sidebar-width: 260px;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            overflow-x: hidden; /* Verhindert seitliches Scrollen */
        }

        /* --- HEADER & NAVIGATION --- */
        header {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            border-bottom: 1px solid #333;
            height: 60px; box-sizing: border-box;
        }

        .menu-btn { font-size: 24px; cursor: pointer; background: none; border: none; color: white; padding: 0; margin-right: 15px; }
        .app-title { font-size: 1.2rem; font-weight: bold; }
        
        /* SIDEBAR */
        #sidebar {
            height: 100%;
            width: var(--sidebar-width);
            position: fixed;
            z-index: 200;
            top: 0;
            left: calc(var(--sidebar-width) * -1); /* Versteckt */
            background-color: #1a1a1a;
            overflow-x: hidden;
            transition: 0.3s;
            padding-top: 80px;
            border-right: 1px solid #333;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }
        
        #sidebar.open { left: 0; }

        .sidebar-link {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 1.1rem;
            color: #ccc;
            display: block;
            transition: 0.2s;
            border-left: 4px solid transparent;
        }
        
        .sidebar-link:hover, .sidebar-link.active {
            color: white;
            background: #252525;
            border-left-color: var(--accent-uni);
        }
        
        .sidebar-divider { height: 1px; background: #333; margin: 10px 20px; }
        .sidebar-label { padding: 20px 25px 5px; font-size: 0.75rem; text-transform: uppercase; color: #555; font-weight: bold; letter-spacing: 1px; }

        /* Overlay (Grauer Hintergrund wenn Men√º offen) */
        #overlay {
            position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7); z-index: 150; cursor: pointer;
        }

        /* --- MAIN CONTENT --- */
        #main-content {
            padding: 80px 20px 40px; /* Platz f√ºr Header */
            max-width: 600px;
            margin: auto;
            min-height: 100vh;
        }

        /* Views (Tabs) */
        .view-section { display: none; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HOME VIEW (FOCUS MODE) --- */
        #timer-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        .status-badge { display: inline-block; padding: 6px 15px; border-radius: 50px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; background: #333; color: #888; margin-bottom: 10px;}
        #display { font-size: 3.5rem; font-weight: 800; font-variant-numeric: tabular-nums; margin: 10px 0 30px; line-height: 1; }
        
        .input-wrapper { margin-bottom: 20px; text-align: left; }
        .input-label { color: #666; font-size: 0.8rem; margin-bottom: 5px; display: block; font-weight: bold; }
        
        input, select { 
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #333; 
            background: #252525; color: white; font-size: 1rem; box-sizing: border-box; outline: none; 
        }
        input:focus, select:focus { border-color: #555; background: #2a2a2a; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .btn-full { grid-column: 1 / -1; }
        
        button { 
            padding: 18px; border: none; border-radius: 16px; cursor: pointer; 
            font-weight: 700; font-size: 1rem; color: white; width: 100%; 
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:active { transform: scale(0.97); }
        
        .btn-fs { background: linear-gradient(135deg, #ff3b30, #cc2d24); } 
        .btn-uni { background: linear-gradient(135deg, #0a84ff, #0060c0); } 
        .btn-free { background: linear-gradient(135deg, #30d158, #249e42); }
        .btn-stop { background: #2c2c2e; border: 2px solid #ff453a; color: #ff453a; }

        /* --- STATS VIEW --- */
        .stat-filter { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .stat-tab { background: #2c2c2e; color: #888; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: 1px solid transparent; }
        .stat-tab.active { background: #444; color: white; border-color: #666; font-weight: bold; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .dash-card { background: var(--card-bg); padding: 15px 10px; border-radius: 12px; text-align: center; }
        .dash-label { font-size: 0.7rem; text-transform: uppercase; color: #666; display: block; margin-bottom: 5px; }
        .dash-val { font-size: 1.2rem; font-weight: bold; color: white; }

        .chart-container { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 150px; }
        .bar-col { width: 12%; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .stacked-bar { width: 100%; display: flex; flex-direction: column-reverse; border-radius: 4px; overflow: hidden; background: #333; min-height: 2px; }
        .segment { width: 100%; }
        .bar-day { font-size: 0.7rem; color: #666; margin-top: 5px; }

        /* --- LOG VIEW --- */
        .log-list { list-style: none; padding: 0; }
        .log-item { background: var(--card-bg); padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .log-info { text-align: left; }
        .log-cat { font-weight: bold; font-size: 0.9rem; margin-bottom: 3px; display: block; }
        .log-meta { font-size: 0.8rem; color: #666; }
        .btn-del { background: transparent; color: #666; width: auto; padding: 5px 10px; font-size: 1.2rem; }

    </style>
</head>
<body>

    <div id="overlay" onclick="closeMenu()"></div>

    <nav id="sidebar">
        <div class="sidebar-label">Navigation</div>
        <a href="#" class="sidebar-link active" onclick="showView('home')">‚è±Ô∏è Fokus Timer</a>
        <a href="#" class="sidebar-link" onclick="showView('stats')">üìä Analyse</a>
        <a href="#" class="sidebar-link" onclick="showView('log')">üìú Verlauf</a>
        
        <div class="sidebar-divider"></div>
        <div class="sidebar-label">Module (Coming Soon)</div>
        <a href="#" class="sidebar-link" style="opacity: 0.5">‚úÖ Aufgaben</a>
        <a href="#" class="sidebar-link" style="opacity: 0.5">üí™ Gewohnheiten</a>
        <a href="#" class="sidebar-link" style="opacity: 0.5">‚öôÔ∏è Einstellungen</a>
    </nav>

    <header>
        <button class="menu-btn" onclick="openMenu()">‚ò∞</button>
        <div class="app-title">Life OS</div>
    </header>

    <main id="main-content">

        <section id="view-home" class="view-section active">
            <div id="timer-card">
                <div id="statusBadge" class="status-badge">Bereit</div>
                <div id="display">00:00:00</div>
                
                <div id="startControls">
                    <div class="input-wrapper">
                        <label class="input-label">T√§tigkeit</label>
                        <select id="fsTypeSelect">
                            <option value="Arbeit">Allgemein</option>
                            <option value="Werkstatt">Werkstatt</option>
                            <option value="Sitzung">Sitzung</option>
                            <option value="Deep Work">Deep Work</option>
                            <option value="Orga">Orga / Emails</option>
                        </select>
                    </div>
                    <div class="input-wrapper">
                        <label class="input-label">Notiz (Optional)</label>
                        <input type="text" id="noteInput" placeholder="Woran arbeitest du?">
                    </div>

                    <div class="btn-grid">
                        <button class="btn-fs" onclick="startWork('FS')">üèéÔ∏è FS</button>
                        <button class="btn-uni" onclick="startWork('Uni')">üéì Uni</button>
                        <button class="btn-free btn-full" onclick="startWork('Freizeit')">üèñÔ∏è Freizeit</button>
                    </div>
                </div>

                <div id="stopControls" style="display:none;">
                    <button class="btn-stop" onclick="stopWork()">‚èπ Session beenden</button>
                    <p style="margin-top:15px; font-size:0.9rem; color:#666; animation: pulse 2s infinite;">Du bist im Fokus-Modus</p>
                </div>
            </div>
            
            <div style="text-align:center; color:#444; font-size:0.8rem; margin-top:20px;">
                "Ordnung ist das halbe Leben."
            </div>
        </section>


        <section id="view-stats" class="view-section">
            <h2 style="margin-top:0">Statistik</h2>
            
            <div class="stat-filter">
                <div class="stat-tab active" id="tabFS" onclick="switchStatFilter('FS')">FS</div>
                <div class="stat-tab" id="tabUni" onclick="switchStatFilter('Uni')">Uni</div>
                <div class="stat-tab" id="tabFree" onclick="switchStatFilter('Freizeit')">Frei</div>
            </div>

            <div class="dashboard-grid">
                <div class="dash-card">
                    <span class="dash-label">Saison 25/26</span>
                    <span class="dash-val" id="valSeason">0h</span>
                </div>
                <div class="dash-card">
                    <span class="dash-label">Jahr 2026</span>
                    <span class="dash-val" id="valYear">0h</span>
                </div>
                <div class="dash-card">
                    <span class="dash-label">√ò / Monat</span>
                    <span class="dash-val" id="valAvg">0h</span>
                </div>
            </div>

            <div class="chart-container">
                <span class="dash-label" style="margin-bottom:15px">Wochentrend (Alle Bereiche)</span>
                <div class="bar-chart" id="weekChart"></div>
            </div>
            
            <button onclick="downloadCSV()" style="background:#333; font-size:0.9rem; padding:12px;">üì• Daten als Excel exportieren</button>
        </section>


        <section id="view-log" class="view-section">
            <h2 style="margin-top:0">Verlauf</h2>
            <ul id="logList" class="log-list"></ul>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, child, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyAKlDrqhXgMASuYkHVQj4TveUt6kjF_pFM",
          authDomain: "zeit-97904.firebaseapp.com",
          databaseURL: "https://zeit-97904-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "zeit-97904",
          storageBucket: "zeit-97904.firebasestorage.app",
          messagingSenderId: "677314069900",
          appId: "1:677314069900:web:6b4baa4d98397dd8cfc2a9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // GLOBAL VARS
        let tInterval;
        let localStartTime = 0;
        let historyData = {};
        let currentFilter = "FS";
        
        const colors = { 'FS': '#ff3b30', 'Uni': '#0a84ff', 'Freizeit': '#30d158' };
        
        // --- NAVIGATION LOGIC ---
        window.openMenu = () => {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').style.display = 'block';
        }
        window.closeMenu = () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').style.display = 'none';
        }
        window.showView = (viewId) => {
            // Hide all sections
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            
            // Show target
            document.getElementById('view-' + viewId).classList.add('active');
            
            // Highlight Menu Item
            // (Simple logic based on order, could be improved but works for now)
            if(viewId === 'home') document.querySelectorAll('.sidebar-link')[0].classList.add('active');
            if(viewId === 'stats') document.querySelectorAll('.sidebar-link')[1].classList.add('active');
            if(viewId === 'log') document.querySelectorAll('.sidebar-link')[2].classList.add('active');
            
            closeMenu();
        }

        // --- FIREBASE LISTENERS ---
        onValue(ref(db, 'status'), (snapshot) => {
            const data = snapshot.val();
            const isRunning = data && data.running;
            
            if (isRunning) {
                localStartTime = data.startTime;
                if (!tInterval) tInterval = setInterval(updateDisplay, 1000);
                
                // UI Update for running
                document.getElementById('startControls').style.display = 'none';
                document.getElementById('stopControls').style.display = 'block';
                document.getElementById('statusBadge').innerText = data.category + (data.subCategory ? " ‚Ä¢ " + data.subCategory : "");
                document.getElementById('statusBadge').style.color = colors[data.category];
                
                // Restore inputs
                if(data.note) document.getElementById('noteInput').value = data.note;
                
            } else {
                if (tInterval) { clearInterval(tInterval); tInterval = null; }
                localStartTime = 0;
                
                // UI Update for stopped
                document.getElementById('display').innerText = "00:00:00";
                document.getElementById('startControls').style.display = 'block';
                document.getElementById('stopControls').style.display = 'none';
                document.getElementById('statusBadge').innerText = "Bereit";
                document.getElementById('statusBadge').style.color = "#888";
                document.getElementById('noteInput').value = "";
            }
        });

        onValue(ref(db, 'history'), (snapshot) => { 
            historyData = snapshot.val() || {};
            processData(); 
        });

        // --- TIMER LOGIC ---
        window.startWork = function(category) {
            const now = new Date().getTime();
            const note = document.getElementById('noteInput').value;
            let subCat = "";
            if (category === 'FS') subCat = document.getElementById('fsTypeSelect').value;

            set(ref(db, 'status'), { running: true, startTime: now, category: category, subCategory: subCat, lastStop: 0, note: note });
        }

        window.stopWork = function() {
            get(child(ref(db), 'status')).then((snapshot) => {
                const state = snapshot.val();
                if (state && state.running) {
                    const now = new Date().getTime();
                    const note = document.getElementById('noteInput').value;
                    push(ref(db, 'history'), { 
                        category: state.category, subCategory: state.subCategory || "", 
                        start: state.startTime, end: now, duration: now - state.startTime, 
                        date: new Date(state.startTime).toLocaleDateString(), note: note 
                    });
                    set(ref(db, 'status'), { running: false, startTime: 0, category: "", lastStop: now, note: "" });
                }
            });
        }

        function updateDisplay() {
            if(!localStartTime) return;
            let diff = new Date().getTime() - localStartTime;
            let hrs = Math.floor(diff / 3600000);
            let mins = Math.floor((diff % 3600000) / 60000);
            let secs = Math.floor((diff % 60000) / 1000);
            document.getElementById('display').innerHTML = (hrs<10?"0"+hrs:hrs) + ':' + (mins<10?"0"+mins:mins) + ':' + (secs<10?"0"+secs:secs);
        }

        // --- DATA & STATS ---
        window.switchStatFilter = (cat) => {
            currentFilter = cat;
            document.querySelectorAll('.stat-tab').forEach(el => el.classList.remove('active'));
            if(cat === 'FS') document.getElementById('tabFS').classList.add('active');
            if(cat === 'Uni') document.getElementById('tabUni').classList.add('active');
            if(cat === 'Freizeit') document.getElementById('tabFree').classList.add('active');
            processData();
        }

        function getSeasonTag(timestamp) {
            const d = new Date(timestamp);
            const month = d.getMonth(); 
            const year = d.getFullYear();
            if (month >= 8) return `${year.toString().substr(2)}/${(year+1).toString().substr(2)}`;
            return `${(year-1).toString().substr(2)}/${year.toString().substr(2)}`;
        }

        function processData() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentSeasonTag = getSeasonTag(now.getTime());
            
            let seasonSum = 0;
            let yearSum = 0;
            let dailySums = {};

            const entries = Object.entries(historyData).sort(([,a],[,b]) => b.start - a.start);
            const listContainer = document.getElementById('logList');
            listContainer.innerHTML = "";

            entries.forEach(([key, entry]) => {
                const dur = entry.duration;
                const cat = entry.category || 'FS';
                
                // 1. Berechne Stats f√ºr den ausgew√§hlten Filter
                if(cat === currentFilter) {
                    if (getSeasonTag(entry.start) === currentSeasonTag) seasonSum += dur;
                    if (new Date(entry.start).getFullYear() === currentYear) yearSum += dur;
                }

                // 2. Berechne Chart Daten (Alle Kategorien)
                const dateKey = new Date(entry.start).toLocaleDateString();
                if(!dailySums[dateKey]) dailySums[dateKey] = { 'FS':0, 'Uni':0, 'Freizeit':0 };
                if(dailySums[dateKey][cat] !== undefined) dailySums[dateKey][cat] += dur;

                // 3. Render List (Letzte 30)
                if(listContainer.children.length < 30) {
                    let li = document.createElement('li');
                    li.className = 'log-item';
                    let hrs = Math.floor(dur / 3600000);
                    let mins = Math.floor((dur % 3600000) / 60000);
                    
                    li.innerHTML = `
                        <div class="log-info">
                            <span class="log-cat" style="color:${colors[cat]}">${cat} ${entry.subCategory ? '‚Ä¢ '+entry.subCategory : ''}</span>
                            <span class="log-meta">${new Date(entry.start).toLocaleDateString()} ‚Ä¢ ${entry.note || '-'}</span>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:bold; color:white;">${hrs}h ${mins}m</div>
                            <button class="btn-del" onclick="deleteItem('${key}')">√ó</button>
                        </div>
                    `;
                    listContainer.appendChild(li);
                }
            });

            // Update Stats UI
            const fmt = (ms) => (ms/3600000).toFixed(1) + "h";
            document.getElementById('valSeason').innerText = fmt(seasonSum);
            document.getElementById('valYear').innerText = fmt(yearSum);
            
            // Simple Avg calc (just divide season sum by approx months passed since Sept)
            let monthsPassed = (now.getFullYear() - parseInt("20" + currentSeasonTag.split('/')[0])) * 12 + (now.getMonth() - 8);
            if(monthsPassed < 1) monthsPassed = 1; else monthsPassed += 1;
            document.getElementById('valAvg').innerText = (seasonSum / monthsPassed / 3600000).toFixed(1) + "h";

            renderChart(dailySums);
        }

        function renderChart(dailySums) {
            const chartDiv = document.getElementById('weekChart');
            chartDiv.innerHTML = "";
            const days = ['So','Mo','Di','Mi','Do','Fr','Sa'];
            
            for (let i = 6; i >= 0; i--) {
                let d = new Date();
                d.setDate(d.getDate() - i);
                let dStr = d.toLocaleDateString();
                let data = dailySums[dStr] || { 'FS':0, 'Uni':0, 'Freizeit':0 };
                let total = data.FS + data.Uni + data.Freizeit;
                
                // Max Scale fix 12h
                let hPercent = Math.min((total / (12*3600000)) * 100, 100);
                
                let pFS = total ? (data.FS/total)*100 : 0;
                let pUni = total ? (data.Uni/total)*100 : 0;
                let pFree = total ? (data.Freizeit/total)*100 : 0;

                chartDiv.innerHTML += `
                    <div class="bar-col">
                        <div class="stacked-bar" style="height:${hPercent}%">
                            <div class="segment" style="height:${pFS}%; background:${colors.FS}"></div>
                            <div class="segment" style="height:${pUni}%; background:${colors.Uni}"></div>
                            <div class="segment" style="height:${pFree}%; background:${colors.Freizeit}"></div>
                        </div>
                        <span class="bar-day">${days[d.getDay()]}</span>
                    </div>
                `;
            }
        }

        window.deleteItem = function(key) {
            if(confirm("Eintrag wirklich l√∂schen?")) remove(ref(db, 'history/' + key));
        }
        
        window.downloadCSV = function() {
            let csv = "Datum,Saison,Kategorie,Notiz,Dauer_Min\n";
            Object.values(historyData).forEach(e => {
                csv += `${new Date(e.start).toLocaleDateString()},${getSeasonTag(e.start)},${e.category},${(e.note||"").replace(/,/g," ")},${Math.round(e.duration/60000)}\n`;
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "LifeOS_Export.csv";
            link.click();
        }

    </script>
</body>
</html>
