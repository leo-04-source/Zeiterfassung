<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Race Control Tracker</title>
    <style>
        /* --- MOTORSPORT THEME CSS --- */
        body { 
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; 
            background-color: #0d0d0d; 
            background-image: 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a),
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a);
            background-size: 4px 4px;
            background-position: 0 0, 2px 2px;
            color: #e0e0e0; 
            overflow-x: hidden; 
        }
        
        .app-layout { display: flex; min-height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 250px; background: #111; border-right: 2px solid #333;
            display: flex; flex-direction: column; padding: 20px; position: fixed; height: 100%; z-index: 100;
            transition: transform 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        .sidebar-title { 
            font-size: 1.1rem; font-weight: 900; color: #fff; margin-bottom: 30px; padding-left: 10px; 
            text-transform: uppercase; letter-spacing: 2px; border-left: 4px solid #ff3b30; padding-left: 15px; font-style: italic;
        }
        .nav-item {
            padding: 12px 15px; margin-bottom: 8px; border-radius: 4px; color: #666; text-decoration: none;
            font-size: 0.85rem; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; gap: 10px;
            transition: 0.2s; cursor: pointer; border: 1px solid transparent;
        }
        .nav-item:hover { background: #222; color: #fff; border-color: #444; }
        .nav-item.active { background: #222; color: #ff3b30; border-color: #ff3b30; }
        
        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; margin-left: 250px; padding: 20px; display: flex; justify-content: center; align-items: flex-start; }
        .view-container { width: 100%; max-width: 600px; text-align: center; margin-bottom: 80px; display: none; }
        .view-container.active-view { display: block; }

        .card-box { 
            background: #161616; padding: 25px; border-radius: 8px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-bottom: 20px; position: relative;
        }
        .card-box::before, .card-box::after { content: ''; position: absolute; top: 10px; width: 4px; height: 4px; background: #333; border-radius: 50%; box-shadow: 0 0 2px #000 inset; }
        .card-box::before { left: 10px; } .card-box::after { right: 10px; }

        .menu-toggle {
            display: none; position: fixed; top: 15px; left: 15px; z-index: 101;
            background: #222; border: 1px solid #ff3b30; color: #fff; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 1.2rem;
        }

        h1 { margin: 0; font-size: 1.6rem; color: #fff; margin-bottom: 5px; text-transform: uppercase; font-style: italic; letter-spacing: 1px; font-weight: 900;}
        p.subtitle { color: #666; margin-bottom: 25px; font-size: 0.75em; text-transform: uppercase; letter-spacing: 2px;}
        
        #display { 
            font-family: 'Courier New', Courier, monospace; font-size: 3.8em; margin: 15px 0 25px 0; 
            font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); letter-spacing: -2px;
        }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-label { font-size: 0.7em; color: #ff3b30; margin-bottom: 5px; display: block; margin-left: 2px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px;}
        
        input, select { 
            width: 100%; padding: 15px; border-radius: 6px; border: 1px solid #333; background: #000; color: #0a84ff; 
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 1rem; box-sizing: border-box; outline: none; appearance: none; transition: 0.3s;
        }
        input:focus, select:focus { border-color: #0a84ff; box-shadow: 0 0 10px rgba(10, 132, 255, 0.2); }
        #fsTypeSelect, #modalCat { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ff3b30%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px center; background-size: 12px; }
        
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.75em; font-weight: 900; text-transform: uppercase; margin-bottom: 15px; background: #222; color: #666; letter-spacing: 1px; border: 1px solid #333;}
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        button { 
            padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
            transition: transform 0.1s, filter 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.8rem; color: white; width: 100%;
            border-bottom: 3px solid rgba(0,0,0,0.3);
        }
        button:active { transform: translateY(2px); border-bottom-width: 0; }
        
        .btn-fs { background: linear-gradient(180deg, #ff3b30, #c41e15); } 
        .btn-uni { background: linear-gradient(180deg, #0a84ff, #0056b3); } 
        .btn-free { background: linear-gradient(180deg, #30d158, #1da33d); }
        .btn-sleep-action { background: linear-gradient(180deg, #bf5af2, #8e44ad); margin-top: 10px;}
        .btn-stop { background: repeating-linear-gradient(45deg, #2c2c2e, #2c2c2e 10px, #3a3a3c 10px, #3a3a3c 20px); border: 2px solid #ff453a; color: #ff453a; display: none; padding: 20px; font-size: 1rem; }
        
        .btn-add-event { background: #222; border: 1px dashed #666; color: #888; margin-top: 15px; }
        .btn-add-event:hover { background: #333; color: #fff; border-color: #fff; }

        .btn-import { background: #222; border: 1px solid #444; color: #666; margin-top: 5px; font-size: 0.7rem; padding: 8px; }

        .stat-filter { display: flex; justify-content: center; gap: 5px; margin-top: 30px; margin-bottom: 10px; flex-wrap: wrap;}
        .stat-tab { background: #111; border: 1px solid #333; color: #666; padding: 6px 15px; border-radius: 4px; font-size: 0.75em; cursor: pointer; margin-bottom: 5px; text-transform: uppercase; font-weight: bold;}
        .stat-tab.active { background: #333; color: white; border-color: #888; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .dash-card { background: #111; padding: 10px; border-radius: 6px; text-align: left; border-left: 3px solid #333; }
        .dash-label { font-size: 0.6em; text-transform: uppercase; color: #666; font-weight: 900; display: block; margin-bottom: 5px; }
        .dash-val { font-size: 1.2em; font-weight: 700; color: #fff; display: block; font-family: 'Courier New', monospace;}
        .dash-sub { font-size: 0.6em; color: #444; font-weight: normal; margin-top: 2px; display: block; text-transform: uppercase;}

        .chart-container { margin-top: 20px; padding: 20px; background: #111; border-radius: 6px; border: 1px solid #333; }
        .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; padding-bottom: 20px; }
        .bar-col { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; width: 12%; }
        .stacked-bar { width: 100%; border-radius: 2px; overflow: hidden; display: flex; flex-direction: column-reverse; background: #222; min-height: 2px; transition: height 0.5s;}
        .segment { width: 100%; }
        .bar-day { font-size: 0.6em; color: #666; margin-top: 5px; font-family: 'Courier New', monospace; font-weight: bold;}

        .sleep-section { background: #111; padding: 15px; border-radius: 6px; margin-top: 20px; border: 1px solid #333; border-left: 3px solid #bf5af2;}
        .sleep-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .btn-export { background: transparent; border: 1px solid #444; color: #666; padding: 10px; font-size: 0.75em; margin-top: 30px; width: auto; display: inline-block; border-radius: 4px; text-transform: uppercase; font-weight: bold;}
        .log-list { list-style: none; padding: 0; text-align: left; margin-top: 25px; font-size: 0.9em; }
        .log-list li { padding: 10px 0; border-bottom: 1px dashed #333; display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 10px;}
        .btn-delete { background: none; border: none; color: #444; font-size: 1.2em; padding: 5px; cursor: pointer;}
        .log-note { display: block; color: #666; font-style: italic; font-size: 0.85em; }
        .sub-tag { display: inline-block; font-size: 0.7em; background: #222; padding: 2px 6px; border-radius: 2px; color: #ccc; margin-left: 5px; vertical-align: middle; border: 1px solid #444;}

        /* --- CALENDAR STYLES --- */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-btn { background: #222; border: 1px solid #444; color: #fff; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .cal-title { font-size: 1.1em; font-weight: 900; text-transform: uppercase; color: #fff; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 20px; }
        .cal-head-day { text-align: center; font-size: 0.6em; color: #666; font-weight: bold; text-transform: uppercase; padding-bottom: 5px;}
        
        .cal-day { 
            background: #111; border: 1px solid #2a2a2a; height: 50px; border-radius: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: 0.2s;
        }
        .cal-day:hover { border-color: #666; background: #1a1a1a; }
        .cal-day.active { border-color: #ff3b30; background: #1a1a1a; box-shadow: 0 0 10px rgba(255,59,48,0.2); }
        .cal-day.empty { background: transparent; border: none; cursor: default; }
        
        .cal-num { font-size: 0.8em; font-weight: bold; color: #888; }
        .cal-val { font-size: 0.7em; font-weight: 800; color: #fff; margin-top: 2px; font-family: 'Courier New', monospace; }
        
        .cal-dots { display: flex; gap: 2px; margin-top: 3px; height: 3px; width: 80%; justify-content: center;}
        .cal-dot { width: 100%; height: 100%; border-radius: 1px; opacity: 0.8; }
        
        .cal-event-mark {
            position: absolute; top: 2px; right: 2px; width: 0; height: 0; 
            border-left: 6px solid transparent; border-top: 6px solid #fff;
        }

        .detail-box { background: #111; padding: 15px; border-radius: 6px; border: 1px solid #333; margin-top: 20px; display: none; }
        .detail-box.show { display: block; animation: fadeIn 0.3s; }
        .detail-title { font-size: 0.8em; font-weight: 900; text-transform: uppercase; color: #666; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; display: flex; justify-content: space-between;}

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal { background: #161616; border: 1px solid #333; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .modal h2 { font-size: 1.2rem; text-transform: uppercase; font-style: italic; margin-top: 0; color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.open { transform: translateX(0); box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
            .main-content { margin-left: 0; padding-top: 60px; }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="eventModal">
    <div class="modal">
        <h2>New Schedule Entry</h2>
        <div class="input-group">
            <span class="input-label">Title / Event</span>
            <input type="text" id="modalTitle" placeholder="Meeting, Deadline, Race...">
        </div>
        <div class="input-group">
            <span class="input-label">Category</span>
            <select id="modalCat">
                <option value="FS">üèéÔ∏è FS Team</option>
                <option value="Uni">üéì Uni</option>
                <option value="Freizeit">üèñÔ∏è Freizeit</option>
                <option value="Sonstiges">‚ö™ Sonstiges</option>
            </select>
        </div>
        <div class="input-group">
            <span class="input-label">Time (Optional)</span>
            <input type="time" id="modalTime">
        </div>
        <div class="btn-grid" style="grid-template-columns: 1fr 1fr; margin-bottom:0;">
            <button onclick="closeModal()" style="background:#333;">Cancel</button>
            <button onclick="saveEvent()" class="btn-uni">Save Entry</button>
        </div>
    </div>
</div>

<button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

<div class="app-layout">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-title">üèÅ Race Control</div>
        <div class="nav-item active" id="nav-dashboard" onclick="showView('dashboard')"><span>üè†</span> Dashboard</div>
        <div class="nav-item" id="nav-tracker" onclick="showView('tracker')"><span>‚è±Ô∏è</span> Telemetry</div>
        <div class="nav-item" id="nav-calendar" onclick="showView('calendar')"><span>üìÖ</span> Schedule</div>
    </div>

    <div class="main-content">
        
        <div id="view-dashboard" class="view-container active-view">
            <div class="card-box">
                <h1>Overview</h1>
                <p class="subtitle">Season 25/26 ‚Ä¢ v7.9 (Fix)</p>
                <p class="input-label" style="text-align:center; margin-bottom:10px;">Quick Launch</p>
                <div class="btn-grid start-buttons-container">
                    <button class="btn-fs" onclick="startWork('FS')">üèéÔ∏è FS Team</button>
                    <button class="btn-uni" onclick="startWork('Uni')">üéì Uni</button>
                    <button class="btn-free" onclick="startWork('Freizeit')">üèñÔ∏è Freizeit</button>
                </div>
                <div class="chart-container">
                    <span class="dash-label" style="margin-bottom:15px">Weekly Pace</span>
                    <div class="bar-chart" id="weekChartDash"></div>
                </div>
                <div style="margin-top:20px; font-size:0.7em; color:#444; text-transform:uppercase;">
                    Career Total: <span id="totalHours" style="color:#fff; font-weight:bold; font-family:'Courier New'">0</span>h
                </div>
            </div>
        </div>

        <div id="view-tracker" class="view-container">
            <div class="card-box">
                <h1>Cockpit</h1>
                <div id="statusBadge" class="status-badge">Box Box</div>
                <div id="display">00:00:00</div>
                <div id="inputArea">
                    <div class="input-group">
                        <span class="input-label">1. Sector Category</span>
                        <select id="fsTypeSelect">
                            <option value="Arbeit">üõ†Ô∏è Arbeit (Allgemein)</option>
                            <option value="Werkstatt">üîß Werkstatt</option>
                            <option value="Sitzung">üó£Ô∏è Sitzung</option>
                            <option value="Au√üentermin">üåç Au√üentermin</option>
                            <option value="Im Auto unterwegs">üöó Im Auto unterwegs</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <span class="input-label">2. Log Note</span>
                        <input type="text" id="noteInput" placeholder="Task description...">
                    </div>
                    <div class="btn-grid start-buttons-container">
                        <button class="btn-fs" onclick="startWork('FS')">üèéÔ∏è FS Team</button>
                        <button class="btn-uni" onclick="startWork('Uni')">üéì Uni</button>
                        <button class="btn-free" onclick="startWork('Freizeit')">üèñÔ∏è Freizeit</button>
                    </div>
                </div>
                <button id="stopBtn" class="btn-stop" onclick="stopWork()">‚èπ BOX BOX (STOP)</button>
                <div class="sleep-section">
                    <span class="input-label" style="margin-bottom:10px">üò¥ Driver Rest</span>
                    <div class="sleep-grid">
                        <input type="date" id="sleepDate">
                        <input type="number" id="sleepHours" placeholder="h" step="0.5">
                    </div>
                    <button class="btn-sleep-action" onclick="addSleep()">üíæ Confirm Rest</button>
                </div>
                <div class="stat-filter">
                    <div class="stat-tab active" id="tabFS" onclick="switchStatView('FS')">üèéÔ∏è FS</div>
                    <div class="stat-tab" id="tabUni" onclick="switchStatView('Uni')">üéì Uni</div>
                    <div class="stat-tab" id="tabFree" onclick="switchStatView('Freizeit')">üèñÔ∏è Frei</div>
                    <div class="stat-tab" id="tabSleep" onclick="switchStatView('Schlaf')">üò¥ Sleep</div>
                </div>
                <div class="dashboard-grid">
                    <div class="dash-card"><span class="dash-label">Season <span id="lblSeason">25/26</span></span><span class="dash-val" id="valSeason">0h</span></div>
                    <div class="dash-card"><span class="dash-label">Year <span id="lblYear">2026</span></span><span class="dash-val" id="valYear">0h</span></div>
                    <div class="dash-card"><span class="dash-label">Avg Pace</span><span class="dash-val" id="valAvg">0h</span></div>
                </div>
                <button class="btn-export" onclick="downloadCSV()">üì• Export Telemetry</button>
                <ul id="logList" class="log-list"></ul>
            </div>
        </div>

        <div id="view-calendar" class="view-container">
            <div class="card-box">
                <h1>Race Schedule</h1>
                <div class="cal-header">
                    <button class="cal-btn" onclick="changeMonth(-1)">‚ùÆ</button>
                    <span class="cal-title" id="calTitle">Loading...</span>
                    <button class="cal-btn" onclick="changeMonth(1)">‚ùØ</button>
                </div>
                <div class="cal-grid" id="calGrid"></div>

                <div style="text-align:right; margin-bottom:10px;">
                    <button class="btn-import" onclick="document.getElementById('icalInput').click()">üì• Import iCal (.ics)</button>
                    <input type="file" id="icalInput" accept=".ics" style="display:none" onchange="importICS(this)">
                </div>

                <div id="calDetail" class="detail-box">
                    <div class="detail-title">
                        <span id="detailDate">Date</span>
                        <span id="detailTotal">Strategy & Data</span>
                    </div>
                    <div id="eventListArea" style="text-align:left; margin-bottom:15px;"></div>
                    <ul id="detailList" class="log-list" style="margin-top:0; border-top:none;"></ul>
                    
                    <button class="btn-add-event" onclick="openModal()">‚ûï Add Event / Termin</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get, child, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKlDrqhXgMASuYkHVQj4TveUt6kjF_pFM",
      authDomain: "zeit-97904.firebaseapp.com",
      databaseURL: "https://zeit-97904-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "zeit-97904",
      storageBucket: "zeit-97904.firebasestorage.app",
      messagingSenderId: "677314069900",
      appId: "1:677314069900:web:6b4baa4d98397dd8cfc2a9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let tInterval;
    let localStartTime = 0;
    let historyData = {};
    let eventData = {}; 
    let calculatedStats = {}; 
    let currentStatView = "FS"; 
    const colors = { 'FS': '#ff3b30', 'Uni': '#0a84ff', 'Freizeit': '#30d158', 'Schlaf': '#bf5af2', 'Sonstiges': '#888' };
    const labels = { 'FS': 'FS Team', 'Uni': 'Uni', 'Freizeit': 'Freizeit', 'Schlaf': 'Schlaf', 'Sonstiges': 'Event' };
    
    let currentCalDate = new Date();
    let selectedDateStr = ""; 

    document.getElementById('sleepDate').valueAsDate = new Date();

    window.showView = function(viewName) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active-view'));
        document.getElementById('view-' + viewName).classList.add('active-view');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-' + viewName).classList.add('active');
        document.getElementById('sidebar').classList.remove('open');
        if(viewName === 'calendar') renderCalendar();
    }

    window.toggleMenu = function() { document.getElementById('sidebar').classList.toggle('open'); }

    // --- IMPORT ICS LOGIC ---
    window.importICS = function(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const events = parseICS(content);
                if(events.length > 0) {
                    if(confirm("Found " + events.length + " events. Import now?")) {
                        events.forEach(ev => {
                             push(ref(db, 'events'), ev);
                        });
                        alert("Import successful!");
                    }
                } else {
                    alert("No compatible events found in file.");
                }
            } catch(err) {
                alert("Error reading file: " + err);
            }
            input.value = ""; 
        };
        reader.readAsText(file);
    }

    function parseICS(icsString) {
        const events = [];
        const lines = icsString.split(/\r\n|\n|\r/);
        let inEvent = false;
        let currentEvent = {};
        
        lines.forEach(line => {
            if(line.startsWith('BEGIN:VEVENT')) {
                inEvent = true;
                currentEvent = {};
            } else if (line.startsWith('END:VEVENT')) {
                inEvent = false;
                if(currentEvent.date && currentEvent.title) {
                    events.push(currentEvent);
                }
            } else if (inEvent) {
                if(line.startsWith('SUMMARY:')) currentEvent.title = line.substring(8);
                if(line.startsWith('DTSTART')) {
                    const parts = line.split(':');
                    const val = parts[1];
                    if(val) {
                        const y = val.substring(0,4);
                        const m = val.substring(4,6);
                        const d = val.substring(6,8);
                        currentEvent.date = parseInt(d) + "." + parseInt(m) + "." + y;
                        
                        if(val.includes('T')) {
                             const timePart = val.split('T')[1];
                             const hh = timePart.substring(0,2);
                             const mm = timePart.substring(2,4);
                             currentEvent.time = hh + ":" + mm;
                        } else {
                             currentEvent.time = "";
                        }
                    }
                }
            }
        });
        events.forEach(e => e.category = 'Sonstiges');
        return events;
    }

    // --- EVENT LOGIC ---
    window.openModal = function() {
        if(!selectedDateStr) return alert("Please select a date first.");
        document.getElementById('eventModal').style.display = 'flex';
        document.getElementById('modalTitle').focus();
    }
    window.closeModal = function() {
        document.getElementById('eventModal').style.display = 'none';
        document.getElementById('modalTitle').value = "";
        document.getElementById('modalTime').value = "";
    }
    window.saveEvent = function() {
        const title = document.getElementById('modalTitle').value;
        const cat = document.getElementById('modalCat').value;
        const time = document.getElementById('modalTime').value;
        if(!title) return alert("Title required");
        push(ref(db, 'events'), { date: selectedDateStr, title: title, category: cat, time: time });
        closeModal();
    }
    window.deleteEvent = function(key) { if(confirm("Delete Event?")) remove(ref(db, 'events/' + key)); }

    // --- CALENDAR LOGIC ---
    window.changeMonth = function(delta) {
        currentCalDate.setMonth(currentCalDate.getMonth() + delta);
        renderCalendar();
    }

    window.selectDate = function(dateStr) {
        selectedDateStr = dateStr;
        const detailBox = document.getElementById('calDetail');
        const detailList = document.getElementById('detailList');
        const eventListArea = document.getElementById('eventListArea');
        const detailDate = document.getElementById('detailDate');

        document.querySelectorAll('.cal-day').forEach(el => el.classList.remove('active'));
        const dayEl = document.getElementById('day-' + dateStr);
        if(dayEl) dayEl.classList.add('active');

        const dayLogs = Object.entries(historyData).filter(([k, v]) => v.date === dateStr).sort(([,a],[,b]) => a.start - b.start);
        const dayEvents = Object.entries(eventData).filter(([k, v]) => v.date === dateStr);

        detailList.innerHTML = "";
        eventListArea.innerHTML = "";

        if(dayEvents.length > 0) {
            dayEvents.forEach(([key, ev]) => {
                const timeStr = ev.time ? `<span style="color:#fff; background:#333; padding:2px 4px; border-radius:3px; font-size:0.8em; margin-right:5px;">${ev.time}</span>` : "";
                const col = colors[ev.category] || "#888";
                eventListArea.innerHTML += `
                    <div style="background:#222; padding:8px; border-left:3px solid ${col}; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                        <div>${timeStr}<span style="font-weight:bold; color:#e0e0e0;">${ev.title}</span></div>
                        <button onclick="deleteEvent('${key}')" style="background:none; border:none; color:#444; padding:0; width:auto; font-size:1.2em;">√ó</button>
                    </div>`;
            });
        }

        let totalMs = 0;
        dayLogs.forEach(([key, entry]) => {
            totalMs += entry.duration;
            let li = document.createElement('li');
            let hrs = Math.floor(entry.duration / 3600000);
            let mins = Math.floor((entry.duration % 3600000) / 60000);
            let subHtml = (entry.category === 'FS' && entry.subCategory) ? `<span class="sub-tag">${entry.subCategory}</span>` : "";
            let catColor = colors[entry.category] || "#888";
            li.innerHTML = `<div><span style="color:${catColor}; font-weight:bold; font-family:'Courier New'">[${labels[entry.category] || entry.category}]</span>${subHtml}<span class="log-note"> ${entry.note || ""}</span></div><strong style="font-family:'Courier New'">${hrs}h ${mins}m</strong>`;
            detailList.appendChild(li);
        });
        detailDate.innerText = dateStr;
        detailBox.classList.add('show');
    }

    function renderCalendar() {
        const grid = document.getElementById('calGrid');
        grid.innerHTML = "";
        ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(d => grid.innerHTML += `<div class="cal-head-day">${d}</div>`);
        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('calTitle').innerText = monthNames[month] + " " + year;
        const firstDay = new Date(year, month, 1).getDay(); 
        let startOffset = firstDay === 0 ? 6 : firstDay - 1; 
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for(let i=0; i<startOffset; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;

        for(let i=1; i<=daysInMonth; i++) {
            const dateObj = new Date(year, month, i);
            const dateStr = dateObj.toLocaleDateString(); 
            let dayDur = 0;
            let catsPresent = new Set();
            Object.values(historyData).forEach(entry => {
                if(entry.date === dateStr) { dayDur += entry.duration; catsPresent.add(entry.category); }
            });

            let hasEvents = Object.values(eventData).some(ev => ev.date === dateStr);
            let valHtml = "";
            let dotHtml = "";
            let eventMarkHtml = hasEvents ? `<div class="cal-event-mark" style="border-top-color:${colors.Uni}"></div>` : ""; 

            if(dayDur > 0) {
                let h = Math.round(dayDur / 3600000 * 10) / 10; 
                valHtml = `<span class="cal-val">${h}h</span>`;
                dotHtml = `<div class="cal-dots">`;
                if(catsPresent.has('FS')) dotHtml += `<div class="cal-dot" style="background:${colors.FS}"></div>`;
                if(catsPresent.has('Uni')) dotHtml += `<div class="cal-dot" style="background:${colors.Uni}"></div>`;
                if(catsPresent.has('Freizeit')) dotHtml += `<div class="cal-dot" style="background:${colors.Freizeit}"></div>`;
                if(catsPresent.has('Schlaf')) dotHtml += `<div class="cal-dot" style="background:${colors.Schlaf}"></div>`;
                dotHtml += `</div>`;
            } else if (hasEvents) {
                 valHtml = `<span class="cal-val" style="color:#666">‚Ä¢</span>`;
            }
            grid.innerHTML += `
            <div class="cal-day" id="day-${dateStr}" onclick="selectDate('${dateStr}')">
                <span class="cal-num">${i}</span>${valHtml}${dotHtml}${eventMarkHtml}
            </div>`;
        }
    }

    // --- STANDARD APP LOGIC ---
    function getSeasonTag(timestamp) {
        const d = new Date(timestamp);
        const month = d.getMonth(); 
        const year = d.getFullYear();
        if (month >= 8) return year.toString().substr(2) + "/" + (year+1).toString().substr(2); 
        else return (year-1).toString().substr(2) + "/" + year.toString().substr(2); 
    }

    onValue(ref(db, 'status'), (snapshot) => {
        const data = snapshot.val();
        if (data && data.running) {
            localStartTime = data.startTime;
            updateUI(true, data.category, data.subCategory);
            if(data.note) document.getElementById('noteInput').value = data.note;
            if(data.subCategory) document.getElementById('fsTypeSelect').value = data.subCategory;
            if (!tInterval) tInterval = setInterval(updateDisplay, 1000);
        } else {
            if (tInterval) { clearInterval(tInterval); tInterval = null; }
            updateUI(false, "");
            document.getElementById('display').innerHTML = "00:00:00";
            document.getElementById('statusBadge').innerText = "Pit Lane";
            document.getElementById('statusBadge').style.color = "#666";
            document.getElementById('noteInput').value = "";
        }
    });

    onValue(ref(db, 'history'), (snapshot) => { 
        historyData = snapshot.val() || {};
        processData(historyData); 
        if(document.getElementById('view-calendar').classList.contains('active-view')) renderCalendar();
    });

    onValue(ref(db, 'events'), (snapshot) => {
        eventData = snapshot.val() || {};
        if(document.getElementById('view-calendar').classList.contains('active-view')) {
            renderCalendar();
            if(selectedDateStr) selectDate(selectedDateStr);
        }
    });

    window.startWork = function(category) {
        showView('tracker');
        const now = new Date().getTime();
        const note = document.getElementById('noteInput').value;
        let subCat = "";
        if (category === 'FS') subCat = document.getElementById('fsTypeSelect').value;
        get(child(ref(db), 'status/lastStop')).then((snapshot) => {
            set(ref(db, 'status'), { running: true, startTime: now, category: category, subCategory: subCat, lastStop: 0, note: note });
        });
    }

    window.stopWork = function() {
        get(child(ref(db), 'status')).then((snapshot) => {
            const state = snapshot.val();
            if (state && state.running) {
                const now = new Date().getTime();
                const finalNote = document.getElementById('noteInput').value;
                push(ref(db, 'history'), { category: state.category, subCategory: state.subCategory || "", start: state.startTime, end: now, duration: now - state.startTime, date: new Date(state.startTime).toLocaleDateString(), note: finalNote });
                set(ref(db, 'status'), { running: false, startTime: 0, category: "", lastStop: now, note: "" });
            }
        });
    }

    window.addSleep = function() {
        const h = parseFloat(document.getElementById('sleepHours').value);
        if(!h || h <= 0) return alert("Enter hours");
        const dateInput = document.getElementById('sleepDate').valueAsDate;
        if(!dateInput) return alert("Date required");
        const dateStr = dateInput.toLocaleDateString(); 
        const durationMs = h * 60 * 60 * 1000;
        const entryTimestamp = dateInput.setHours(8,0,0,0);
        push(ref(db, 'history'), { category: 'Schlaf', subCategory: 'Nachtrag', start: entryTimestamp - durationMs, end: entryTimestamp, duration: durationMs, date: dateStr, note: "Manual Entry" });
        let timeToDeduct = durationMs;
        Object.entries(historyData).forEach(([key, val]) => {
            if(timeToDeduct <= 0) return;
            if(val.category === 'Freizeit' && val.date === dateStr) {
                if(val.duration > timeToDeduct) { update(ref(db, 'history/' + key), { duration: val.duration - timeToDeduct }); timeToDeduct = 0; } 
                else { timeToDeduct -= val.duration; remove(ref(db, 'history/' + key)); }
            }
        });
        alert("Rest logged."); document.getElementById('sleepHours').value = "";
    }

    window.switchStatView = function(view) {
        currentStatView = view;
        document.querySelectorAll('.stat-tab').forEach(el => el.classList.remove('active'));
        if(view === 'FS') document.getElementById('tabFS').classList.add('active');
        if(view === 'Uni') document.getElementById('tabUni').classList.add('active');
        if(view === 'Freizeit') document.getElementById('tabFree').classList.add('active');
        if(view === 'Schlaf') document.getElementById('tabSleep').classList.add('active');
        renderDashboardValues();
    }

    window.deleteItem = function(key) { if(confirm("Delete Log?")) remove(ref(db, 'history/' + key)); }

    window.downloadCSV = function() {
        let csv = "Datum,Saison,Start,Ende,Kategorie,Unterkategorie,Minuten,Notiz\n";
        Object.values(historyData).sort((a,b)=>b.start-a.start).forEach(e => {
            const season = getSeasonTag(e.start);
            const sub = e.subCategory ? e.subCategory : "-";
            const noteClean = (e.note||"").replace(/,/g," ");
            csv += `${new Date(e.start).toLocaleDateString()},${season},${new Date(e.start).toLocaleTimeString()},${new Date(e.end).toLocaleTimeString()},${e.category},${sub},${Math.round(e.duration/60000)},${noteClean}\n`;
        });
        const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "Telemetry_Export.csv"; link.click();
    }

    function updateDisplay() {
        if(!localStartTime) return;
        let diff = new Date().getTime() - localStartTime;
        let hrs = Math.floor(diff / 3600000); let mins = Math.floor((diff % 3600000) / 60000); let secs = Math.floor((diff % 60000) / 1000);
        document.getElementById('display').innerHTML = (hrs<10?"0"+hrs:hrs) + ':' + (mins<10?"0"+mins:mins) + ':' + (secs<10?"0"+secs:secs);
    }

    function updateUI(running, category, subCategory) {
        const startBtnContainers = document.querySelectorAll('.start-buttons-container');
        const stopBtn = document.getElementById('stopBtn');
        if(running) {
            startBtnContainers.forEach(el => el.style.display = 'none');
            stopBtn.style.display = 'block';
            stopBtn.style.borderColor = colors[category] || '#666';
            let badgeText = labels[category] || category;
            if(category === 'FS' && subCategory) badgeText += " // " + subCategory;
            document.getElementById('statusBadge').innerText = "TRACKING: " + badgeText;
            document.getElementById('statusBadge').style.color = colors[category] || '#fff';
            document.getElementById('statusBadge').style.borderColor = colors[category] || '#fff';
        } else {
            startBtnContainers.forEach(el => el.style.display = 'grid');
            stopBtn.style.display = 'none';
        }
    }

    function processData(data) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentSeasonTag = getSeasonTag(now.getTime()); 
        const seasonStartYear = parseInt("20" + currentSeasonTag.split('/')[0]); 
        let monthsPassed = (now.getFullYear() - seasonStartYear) * 12 + (now.getMonth() - 8);
        if (monthsPassed < 1) monthsPassed = 1; else monthsPassed += 1; 

        calculatedStats = { 'FS': {season:0,year:0}, 'Uni': {season:0,year:0}, 'Freizeit': {season:0,year:0}, 'Schlaf': {season:0,year:0} };
        let sumLifetime = 0;
        let dailySums = {}; 

        document.getElementById('lblSeason').innerText = currentSeasonTag;
        document.getElementById('lblYear').innerText = currentYear;

        const entries = Object.entries(data).sort(([,a],[,b]) => b.start - a.start);
        entries.forEach(([key, entry]) => {
            const dur = entry.duration;
            const cat = entry.category || 'FS'; 
            sumLifetime += dur;
            if(calculatedStats[cat]) {
                if (getSeasonTag(entry.start) === currentSeasonTag) calculatedStats[cat].season += dur;
                if (new Date(entry.start).getFullYear() === currentYear) calculatedStats[cat].year += dur;
            }
            const dateKey = new Date(entry.start).toLocaleDateString();
            if(!dailySums[dateKey]) dailySums[dateKey] = { 'FS':0, 'Uni':0, 'Freizeit':0, 'Schlaf':0 };
            if(dailySums[dateKey][cat] !== undefined) dailySums[dateKey][cat] += dur;
        });

        renderDashboardValues(monthsPassed);
        document.getElementById('totalHours').innerText = (sumLifetime / 3600000).toFixed(1);
        renderChart(dailySums);
        renderList(entries);
    }

    function renderDashboardValues(monthsPassedGlobal) {
        if(!monthsPassedGlobal) {
            const now = new Date();
            const seasonStartYear = parseInt("20" + document.getElementById('lblSeason').innerText.split('/')[0]);
            monthsPassedGlobal = (now.getFullYear() - seasonStartYear) * 12 + (now.getMonth() - 8);
            if (monthsPassedGlobal < 1) monthsPassedGlobal = 1; else monthsPassedGlobal += 1;
        }
        const stats = calculatedStats[currentStatView];
        const fmt = (ms) => Math.floor(ms/3600000) + "h " + Math.floor((ms%3600000)/60000) + "m";
        const fmtYr = (ms) => Math.floor(ms/3600000) + "h";
        if(stats) {
            document.getElementById('valSeason').innerText = fmt(stats.season);
            document.getElementById('valYear').innerText = fmtYr(stats.year);
            let avg = stats.season / monthsPassedGlobal;
            document.getElementById('valAvg').innerText = (avg / 3600000).toFixed(1) + "h";
        }
    }

    function renderChart(dailySums) {
        const targetIDs = ['weekChartDash', 'weekChartTrack'];
        const days = ['Su','Mo','Tu','We','Th','Fr','Sa'];
        targetIDs.forEach(id => {
            const chartDiv = document.getElementById(id);
            if(!chartDiv) return;
            chartDiv.innerHTML = "";
            for (let i = 6; i >= 0; i--) {
                let d = new Date(); d.setDate(d.getDate() - i);
                let dStr = d.toLocaleDateString();
                let dayData = dailySums[dStr] || { 'FS':0, 'Uni':0, 'Freizeit':0, 'Schlaf': 0 };
                let totalMs = dayData.FS + dayData.Uni + dayData.Freizeit + (dayData.Schlaf || 0);
                const MAX_SCALE = 16 * 3600000; 
                let totalHeightPercent = Math.min((totalMs / MAX_SCALE) * 100, 100);
                let pFS = totalMs > 0 ? (dayData.FS / totalMs) * 100 : 0;
                let pUni = totalMs > 0 ? (dayData.Uni / totalMs) * 100 : 0;
                let pFree = totalMs > 0 ? (dayData.Freizeit / totalMs) * 100 : 0;
                let pSleep = totalMs > 0 ? (dayData.Schlaf / totalMs) * 100 : 0;
                chartDiv.innerHTML += `
                <div class="bar-col">
                    <div class="stacked-bar" style="height:${totalHeightPercent}%;">
                        <div class="segment" style="height:${pFS}%; background:${colors.FS}"></div>
                        <div class="segment" style="height:${pUni}%; background:${colors.Uni}"></div>
                        <div class="segment" style="height:${pFree}%; background:${colors.Freizeit}"></div>
                        <div class="segment" style="height:${pSleep}%; background:${colors.Schlaf}"></div>
                    </div>
                    <span class="bar-day">${days[d.getDay()]}</span>
                </div>`;
            }
        });
    }

    function renderList(entries) {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        entries.slice(0, 20).forEach(([key, entry]) => {
            let li = document.createElement('li');
            let hrs = Math.floor(entry.duration / 3600000);
            let mins = Math.floor((entry.duration % 3600000) / 60000);
            let subHtml = (entry.category === 'FS' && entry.subCategory) ? `<span class="sub-tag">${entry.subCategory}</span>` : "";
            let catColor = colors[entry.category] || "#888";
            li.innerHTML = `<div><span style="color:${catColor}; font-weight:bold; font-family:'Courier New'">[${labels[entry.category] || entry.category}]</span>${subHtml}<div class="log-meta" style="color:#444; font-size:0.8em; margin-top:2px;">${new Date(entry.start).toLocaleDateString()} ${new Date(entry.start).toLocaleTimeString().substr(0,5)}</div><span class="log-note">${entry.note || ""}</span></div><strong style="font-family:'Courier New'">${hrs}h ${mins}m</strong><button class="btn-delete" onclick="deleteItem('${key}')">√ó</button>`;
            list.appendChild(li);
        });
    }
</script>
</body>
</html>
